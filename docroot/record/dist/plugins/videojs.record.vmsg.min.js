/*!
 * vmsg plugin for videojs-record
 * @version 3.9.0
 * @see https://github.com/collab-project/videojs-record
 * @copyright 2014-2020 Collab
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("videojs")):"function"==typeof define&&define.amd?define("vmsg",["videojs"],t):"object"==typeof exports?exports.vmsg=t(require("videojs")):(e.VideojsRecord=e.VideojsRecord||{},e.VideojsRecord.vmsg=t(e.videojs))}(window,(function(e){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(n,s,function(t){return e[t]}.bind(null,s));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=27)}({0:function(t,i){t.exports=e},27:function(e,t,i){"use strict";i.r(t);var n=i(0),s=i.n(n);function o(){function e(e,t){return new Promise((i,n)=>{const s=new XMLHttpRequest;s.open("GET",e),s.responseType="arraybuffer",s.onload=()=>{i(WebAssembly.instantiate(s.response,t))},s.onerror=n,s.send()})}let t=null,i=5242880;function n(e){const t=i;return i+=e,t}function s(e){postMessage({type:"internal-error",data:e})}let o=null,r=null,a=null;onmessage=i=>{const c=i.data;switch(c.type){case"init":const{wasmURL:i,shimURL:u}=c.data;Promise.resolve().then(()=>(self.WebAssembly&&!function(){const e=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),t=new WebAssembly.Module(e);return 0!==new WebAssembly.Instance(t,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(u),t=new WebAssembly.Memory({initial:256,maximum:256}),{memory:t,pow:Math.pow,exit:s,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:n})).then(t=>function(t,i){if(!WebAssembly.instantiateStreaming)return e(t,i);const n=fetch(t,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(n,i).catch(n=>{if(n.message&&n.message.indexOf("Argument 0 must be provided and must be a Response")>0)return e(t,i);throw n})}(i,{env:t})).then(e=>{o=e.instance.exports,postMessage({type:"init",data:null})}).catch(e=>{postMessage({type:"init-error",data:e.toString()})});break;case"start":if(!function(e){if(r=o.vmsg_init(e),!r)return!1;const i=new Uint32Array(t.buffer,r,1)[0];return a=new Float32Array(t.buffer,i),!0}(c.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(l=c.data,a.set(l),!(o.vmsg_encode(r,l.length)>=0))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const h=function(){if(o.vmsg_flush(r)<0)return null;const e=new Uint32Array(t.buffer,r+4,1)[0],i=new Uint32Array(t.buffer,r+8,1)[0],n=new Uint8Array(t.buffer,e,i),s=new Blob([n],{type:"audio/mpeg"});return o.vmsg_free(r),r=null,a=null,s}();if(!h)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:h})}var l}}class r{constructor(e={},t=null){this.wasmURL=new URL(e.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(e.shimURL||"/static/js/wasm-polyfill.js",location).href,this.onStop=t,this.pitch=e.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&this.worker.terminate(),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}initAudio(){return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(e){return navigator.mediaDevices.getUserMedia(e)}:function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(i,n){t.call(navigator,e,i,n)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then(e=>{this.stream=e;const t=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),i=t.createMediaStreamSource(e),n=this.gainNode=(t.createGain||t.createGainNode).call(t);n.gain.value=1,i.connect(n);const s=this.pitchFX=new c(t);s.setPitchOffset(this.pitch);const o=this.encNode=(t.createScriptProcessor||t.createJavaScriptNode).call(t,0,1,1);s.output.connect(o),n.connect(0===this.pitch?o:s.input)})}initWorker(){if(!this.stream)throw new Error("missing audio initialization");const e=new Blob(["(",o.toString(),")()"],{type:"application/javascript"}),t=this.workerURL=URL.createObjectURL(e),i=this.worker=new Worker(t),{wasmURL:n,shimURL:s}=this;return i.postMessage({type:"init",data:{wasmURL:n,shimURL:s}}),new Promise((e,t)=>{i.onmessage=i=>{const n=i.data;switch(n.type){case"init":e();break;case"init-error":t(new Error(n.data));break;case"error":case"internal-error":console.error("Worker error:",n.data),this.reject&&this.reject(n.data);break;case"stop":this.blob=n.data,this.blobURL=URL.createObjectURL(n.data),this.onStop&&this.onStop(),this.resolve&&this.resolve(this.blob)}}})}init(){return this.initAudio().then(this.initWorker.bind(this))}startRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:t})},this.encNode.connect(this.audioCtx.destination)}stopRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.stopTracks(),this.worker.postMessage({type:"stop",data:null}),new Promise((e,t)=>{this.resolve=e,this.reject=t})}stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach(e=>e.stop())}}function a(e,t,i,n){for(var s=t*e.sampleRate,o=s+(t-2*i)*e.sampleRate,r=e.createBuffer(1,o,e.sampleRate),a=r.getChannelData(0),c=0;c<s;++c)a[c]=n?(s-c)/o:c/s;for(c=s;c<o;++c)a[c]=0;return r}function c(e){this.context=e;var t=(e.createGain||e.createGainNode).call(e),i=(e.createGain||e.createGainNode).call(e);this.input=t,this.output=i;var n=e.createBufferSource(),s=e.createBufferSource(),o=e.createBufferSource(),r=e.createBufferSource();this.shiftDownBuffer=a(e,.1,.05,!1),this.shiftUpBuffer=a(e,.1,.05,!0),n.buffer=this.shiftDownBuffer,s.buffer=this.shiftDownBuffer,o.buffer=this.shiftUpBuffer,r.buffer=this.shiftUpBuffer,n.loop=!0,s.loop=!0,o.loop=!0,r.loop=!0;var c=(e.createGain||e.createGainNode).call(e),l=(e.createGain||e.createGainNode).call(e),u=(e.createGain||e.createGainNode).call(e);u.gain.value=0;var h=(e.createGain||e.createGainNode).call(e);h.gain.value=0,n.connect(c),s.connect(l),o.connect(u),r.connect(h);var d=(e.createGain||e.createGainNode).call(e),f=(e.createGain||e.createGainNode).call(e),p=(e.createDelay||e.createDelayNode).call(e),m=(e.createDelay||e.createDelayNode).call(e);c.connect(d),l.connect(f),u.connect(d),h.connect(f),d.connect(p.delayTime),f.connect(m.delayTime);var g=e.createBufferSource(),b=e.createBufferSource(),w=function(e,t,i){for(var n=t*e.sampleRate,s=n+(t-2*i)*e.sampleRate,o=e.createBuffer(1,s,e.sampleRate),r=o.getChannelData(0),a=i*e.sampleRate,c=a,l=n-a,u=0;u<n;++u){var h;h=u<c?Math.sqrt(u/a):u>=l?Math.sqrt(1-(u-l)/a):1,r[u]=h}for(u=n;u<s;++u)r[u]=0;return o}(e,.1,.05);g.buffer=w,b.buffer=w,g.loop=!0,b.loop=!0;var v=(e.createGain||e.createGainNode).call(e),y=(e.createGain||e.createGainNode).call(e);v.gain.value=0,y.gain.value=0,g.connect(v.gain),b.connect(y.gain),t.connect(p),t.connect(m),p.connect(v),m.connect(y),v.connect(i),y.connect(i);var R=e.currentTime+.05,U=R+.1-.05;n.start(R),s.start(U),o.start(R),r.start(U),g.start(R),b.start(U),this.mod1=n,this.mod2=s,this.mod1Gain=c,this.mod2Gain=l,this.mod3Gain=u,this.mod4Gain=h,this.modGain1=d,this.modGain2=f,this.fade1=g,this.fade2=b,this.mix1=v,this.mix2=y,this.delay1=p,this.delay2=m,this.setDelay(.1)}c.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},c.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(.1*Math.abs(e))};const l=s.a.getComponent("RecordEngine");class u extends l{constructor(e,t){super(e,t),this.debug=!1,this.audioWebAssemblyURL="vmsg.wasm",this.pluginLibraryOptions={}}setup(e,t,i){this.inputStream=e,this.mediaType=t,this.debug=i,this.config={wasmURL:this.audioWebAssemblyURL},this.config=Object.assign(this.config,this.pluginLibraryOptions),this.engine=new r(this.config,this.onRecordingAvailable.bind(this)),this.engine.stream=this.inputStream;let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.audioSourceNode=this.audioContext.createMediaStreamSource(this.inputStream),this.processor=this.audioContext.createScriptProcessor(0,1,1),this.audioSourceNode.connect(this.processor),this.engine.initWorker().catch(e=>{this.player().trigger("error",e)})}start(){this.engine.blob=null,this.engine.blobURL&&URL.revokeObjectURL(this.engine.blobURL),this.engine.blobURL=null,this.engine.worker.postMessage({type:"start",data:this.audioContext.sampleRate}),this.processor.onaudioprocess=this.onAudioProcess.bind(this),this.processor.connect(this.audioContext.destination)}stop(){this.processor&&(this.processor.disconnect(),this.processor.onaudioprocess=null),this.engine&&void 0!==this.engine.worker&&this.engine.worker.postMessage({type:"stop",data:null})}destroy(){this.engine&&"function"==typeof this.engine.close&&this.engine.close()}onAudioProcess(e){const t=e.inputBuffer.getChannelData(0);this.engine.worker.postMessage({type:"data",data:t})}onRecordingAvailable(){this.onStopRecording(this.engine.blob)}}s.a.VmsgEngine=u;t.default=u}})}));